<!DOCTYPE html>
<html lang="fr">
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StrexBot</title>
    <link rel="icon" type="image/png" href="/S.png">
    <link rel="stylesheet" href="/style.css?v=1.0.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <meta name="description" content="StrexBot - Bot Discord pour développer et gérer votre serveur avec des commandes avancées. Système de pièces, cadeaux et récompenses quotidiennes.">
    <meta name="keywords" content="strexbot, bot discord, serveur discord, commandes discord, bot français">
    <meta name="author" content="StrexBot">
    <meta name="robots" content="index, follow">

    <!-- Open Graph amélioré -->
    <meta property="og:title" content="StrexBot - Bot Discord">
    <meta property="og:description" content="Le meilleur bot Discord pour développer votre serveur avec des commandes avancées, système de récompenses.">
    <meta property="og:site_name" content="StrexBot">
    <meta property="og:locale" content="fr_FR">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="StrexBot - Bot Discord">
    <meta name="twitter:description" content="Bot Discord avancé avec système de pièces et récompenses">

    <meta name="theme-color" content="#f59e0b">
</head>
<body>
    <div id="app-container"></div>
    <div id="toast-container"></div>
    
    <div id="my-codes-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('my-codes-modal')">&times;</button>
            <h2><i class="fas fa-list"></i> Mes Codes Cadeaux Actifs</h2>
            <div id="my-codes-list"></div>
        </div>
    </div>

    <script type="text/javascript">
        window.$crisp=[];
        window.CRISP_WEBSITE_ID="a9464da0-7c27-4793-b733-690b11a13b19";
        (function(){
            d=document;s=d.createElement("script");
            s.src="https://client.crisp.chat/l.js";
            s.async=1;
            d.getElementsByTagName("head")[0].appendChild(s);
        })();
    </script>

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "d5c2d482-5e8c-4c25-9238-739c77c25d9c",
        });
      });
    </script>

    <div id="create-gift-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('create-gift-modal')">&times;</button>
            <h2><i class="fas fa-gift"></i> Créer un Code Cadeau</h2>
            <div class="gift-creation-content">
                <p>Créez un code cadeau unique pour partager vos pièces avec vos amis!</p>
                <div class="amount-selector">
                    <label for="gift-amount">Montant à offrir</label>
                    <input type="number" step="0.01" id="gift-amount" min="0.01" placeholder="Ex: 10.50">
                    <div class="amount-buttons">
                        <button onclick="setGiftAmount(5)">5</button>
                        <button onclick="setGiftAmount(10)">10</button>
                        <button onclick="setGiftAmount(25)">25</button>
                        <button onclick="setGiftAmount(50)">50</button>
                    </div>
                </div>
                <button class="btn-create-gift" onclick="createGift()">
                    <i class="fas fa-magic"></i> Créer le Code
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_URL = 'https://api-s5et.onrender.com';
        const SITE_URL = 'https://strexbot.xyz';
        const DISCORD_CLIENT_ID = '1379440380860174506';

        // --- Démarrage de l'Application ---
        document.addEventListener('DOMContentLoaded', async () => {
            window.addEventListener('popstate', handleUrlChange);
            handleTokenRedirect();
            try {
                const statusRes = await fetch(`${API_URL}/api/status`);
                const statusData = await statusRes.json();
                if (statusData.maintenance) {
                    const token = localStorage.getItem('jwt_token');
                    let isAdmin = false;
                    if (token) {
                        try {
                            const userRes = await fetch(`${API_URL}/api/user_data`, { headers: { 'Authorization': `Bearer ${token}` } });
                            if (userRes.ok) isAdmin = (await userRes.json()).is_admin;
                        } catch {}
                    }
                    if (isAdmin) handleUrlChange();
                    else renderMaintenancePage();
                } else {
                    handleUrlChange();
                }
            } catch (error) {
                console.error("Erreur au démarrage:", error);
                handleUrlChange();
            }
        });

        function handleTokenRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const error = urlParams.get('error');
            if (token) {
                localStorage.setItem('jwt_token', token);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (error) {
                showToast("La connexion a échoué.", "error");
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // --- Routeur JavaScript ---
        function handleUrlChange() {
            // Récupérer le chemin depuis l'URL ou le paramètre
            const urlParams = new URLSearchParams(window.location.search);
            const pathFromParam = urlParams.get('path');
            const path = pathFromParam || window.location.pathname;
        
            if (pathFromParam) {
                // Nettoyer l'URL en supprimant le paramètre
                window.history.replaceState({}, '', '/' + pathFromParam);
            }
        
            // Votre logique existante...
            if (path.startsWith('/redeem/')) {
                const code = path.split('/redeem/')[1];
                renderGiftsPage(code);
            } else if (path.startsWith('/invite/')) {
                const inviterId = path.split('/invite/')[1];
                renderInvitePage(inviterId);
            } else if (path.startsWith('/admin')) {
                renderAdminPage();
            } else if (path.startsWith('/gifts')) {
                renderGiftsPage();
            } else if (path.startsWith('/history')) {
                renderHistoryPage();
            } else if (path.startsWith('/buy')) {
                renderBuyPage();
            } else if (path.startsWith('/daily')) {
                renderDailyPage();
            } else if (path.startsWith('/earn')) {
                renderEarnPage();
            } else {
                renderHomePage();
            }
        }

        function navigate(path) {
            window.history.pushState({}, '', path);
            handleUrlChange();
        }

        // --- Fonctions de Rendu des Pages ---
        function renderMaintenancePage() {
            document.title = 'StrexBot - Maintenance';
            document.getElementById('app-container').innerHTML = `<div class="error-page"><h1>Maintenance</h1><p>Le site est actuellement en cours de maintenance. Veuillez réessayer plus tard.</p></div>`;
        }

        async function generateInviteLink() {
            try {
                const result = await apiFetch('/api/my_invite_link');
                if (result.success) {
                    document.getElementById('invite-link-input').value = result.invite_link;
                    document.getElementById('invite-link-display').style.display = 'block';
                }
            } catch (error) {
                showToast("Erreur lors de la génération du lien", "error");
            }
        }

        function copyInviteLink() {
            const input = document.getElementById('invite-link-input');
            input.select();
            navigator.clipboard.writeText(input.value);
            showToast("Lien d'invitation copié!", "success");
        }
        
        async function renderHomePage() {
            document.title = 'StrexBot - Accueil';
            document.getElementById('app-container').innerHTML = `
                <div class="container">
                    <nav>
                        <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                            <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                        </div>
                        <div id="user-section"></div>
                    </nav>
                    <header class="hero">
                        <h1 class="hero-title">
                            Le meilleur moyen de développer<br>votre serveur
                        </h1>
                        <p>Avec StrexBot, obtenez des commandes à portée de main.</p>
                        <div id="global-offer-container"></div>
                    </header>
                    <main>
                        <section class="features fade-in-section">
                            <!-- Supprimer <div id="global-offer-container"></div> d'ici -->
                            <div class="feature-item"><i class="fas fa-rocket"></i><h3>Rapide et Efficace</h3><p>Utilisez des préfixes rapides pour des réponses instantanées.</p></div>
                            <div class="feature-item"><i class="fas fa-shield-alt"></i><h3>Sûr et Sécurisé</h3><p>Notre système est conçu pour être sûr pour votre serveur et vos données.</p></div>
                            <div class="feature-item"><i class="fas fa-users"></i><h3>Communauté Active</h3><p>Nous nous concentrons sur la qualité du bot et des commandes.</p></div>
                         </section>
                         <section class="stats fade-in-section">
                            <div class="stat-item"><h2>+10</h2><p>Serveurs</p></div>
                            <div class="stat-item"><h2>+34</h2><p>Utilisateurs</p></div>
                            <div class="stat-item"><h2>+44</h2><p>Membres Délivrés</p></div>
                         </section>
                    </main>
                    <footer class="footer"><p>&copy; 2025 StrexBot. Tous droits réservés.</p></footer>
                </div>
            `;
            updateUserSection();
            setupScrollAnimations();
            loadGlobalOffer();
        }
        
        // Version corrigée qui évite l'erreur null
        async function redeemGiftCode(directCode = null) {
            console.log('redeemGiftCode appelée avec:', directCode);
    
            let code;
    
            if (directCode) {
                // Si un code direct est fourni, l'utiliser
                code = directCode;
            } else {
                // Sinon, essayer de récupérer depuis l'input (seulement s'il existe)
                const inputElement = document.getElementById('redeem-code-input');
                if (inputElement) {
                    code = inputElement.value.trim();
                } else {
                    code = '';
                }
            }
    
            console.log('Code final:', code);

            if (!code) {
                console.log('Aucun code trouvé');
                showToast("Veuillez entrer un code.", "error");
                return;
            }

            // Désactiver le bouton pendant le traitement
            const button = event?.target;
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Réclamation...';
            }

            try {
                console.log('Envoi de la requête API...');
                const result = await apiFetch('/api/gifts/redeem', { 
                    method: 'POST', 
                    body: JSON.stringify({ code }) 
                });

                console.log('Résultat API:', result);

                if (result && result.success) {
                    showToast(result.message, 'success');

                    // Si on est sur une page de redeem directe, rediriger vers l'accueil
                    if (window.location.pathname.startsWith('/redeem/')) {
                        setTimeout(() => navigate('/'), 2000);
                    } else {
                        // Vider l'input seulement s'il existe
                        const inputElement = document.getElementById('redeem-code-input');
                        if (inputElement) {
                            inputElement.value = '';
                        }
                    }

                    await updateUserSection();
                }
            } catch (error) {
                console.error('Erreur lors de la réclamation:', error);
                showToast(error.error || "Une erreur est survenue.", "error");
            } finally {
                // Réactiver le bouton
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-gift"></i> Réclamer mon cadeau';
                }
            }
        }
        // Nouvelle fonction pour récupérer les infos d'un code cadeau
        async function getGiftCodeInfo(code) {
            try {
                // Vous devrez créer cette route API qui retourne juste les infos du code sans le réclamer
                const response = await apiFetch(`/api/gifts/info/${code}`);
                return response;
            } catch (error) {
                return { valid: false, amount: 0 };
            }
        }

        // 2. Version corrigée de renderGiftsPage avec la partie redeem
        async function renderGiftsPage(prefilledCode = '') {
            document.title = 'StrexBot - Cadeaux';
            const container = document.getElementById('app-container');
            const userData = await apiFetch('/api/user_data').catch(() => null);

            if (!userData) {
                container.innerHTML = `<div class="error-page"><h1>Veuillez vous connecter</h1><p>Vous devez être connecté pour accéder à cette page.</p><a href="/" onclick="event.preventDefault(); navigate('/')">Retour à l'accueil</a></div>`;
                return;
            }

            // SI C'EST UNE PAGE DE REDEEM DIRECTE
            if (prefilledCode && prefilledCode.startsWith('ST-')) {
                // Récupérer les infos du code cadeau
                const giftInfo = await getGiftCodeInfo(prefilledCode);

                container.innerHTML = `
                    <div class="container">
                        <nav>
                            <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                                <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                            </div>
                            <div id="user-section"></div>
                        </nav>
                        <main class="redeem-landing">
                            <div class="redeem-hero">
                                <div class="gift-icon-large">🎁</div>
                                <h1>${giftInfo && giftInfo.valid ? 'Cadeau trouvé !' : 'Cadeau invalide'}</h1>
                                <p>${giftInfo && giftInfo.valid ? 'Un cadeau vous attend !' : 'Ce code cadeau n\'est plus disponible'}</p>
                            </div>
            
                            <div class="gift-preview-card">
                                ${giftInfo && giftInfo.valid ? 
                                    `<div class="gift-amount-display">
                                        <img src="/Coin.png" class="gift-coin-large">
                                        <span class="gift-amount-number">${giftInfo.amount}</span>
                                        <span class="gift-amount-text">pièces</span>
                                    </div>
                    
                                    <div class="gift-code-display">
                                        <span class="gift-code">Code: ${prefilledCode}</span>
                                    </div>
                    
                                    <button class="btn-claim-gift-large" onclick="claimDirectGift('${prefilledCode}')">
                                        <i class="fas fa-gift"></i> Réclamer mon cadeau
                                    </button>` :
                                    `<div class="gift-error">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        ${giftInfo ? giftInfo.error : 'Code invalide'}
                                    </div>`
                                }
                
                                <p class="gift-footer">
                                    <a href="/gifts" onclick="event.preventDefault(); navigate('/gifts')">
                                        Gérer mes propres codes cadeaux
                                    </a>
                                </p>
                            </div>
                        </main>
                    </div>
                `;
                updateUserSection();
                return;
            }

            // PAGE GIFTS NORMALE - REMETTEZ VOTRE CONTENU ORIGINAL ICI
            container.innerHTML = `
                <div class="container">
                    <nav>
                        <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                            <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                        </div>
                        <div id="user-section"></div>
                    </nav>
                    <main class="gifts-main">
                        <div class="gifts-hero">
                            <h1><i class="fas fa-gift gradient-icon"></i> Centre des Cadeaux</h1>
                            <p>Partagez la joie avec vos amis en créant des codes cadeaux personnalisés !</p>
                        </div>

                        <div class="gifts-content">
                            <div class="gift-card primary-card">
                                <div class="card-header">
                                    <i class="fas fa-magic"></i>
                                    <h3>Créer un Cadeau</h3>
                                    <button class="btn-my-codes" onclick="showMyCodes()">
                                        <i class="fas fa-list"></i> Mes codes (<span id="codes-count-header">...</span>)
                                    </button>
                                </div>
                                <p>Transformez vos pièces en cadeaux magiques à partager !</p>
                                <div class="balance-display">
                                    <img src="/Coin.png" class="balance-coin">
                                    <span id="user-balance">${userData.coins.toLocaleString()}</span>‎‎ pièces disponibles
                                </div>
                                <button class="btn-gift-action" onclick="openModal('create-gift-modal')">
                                    <i class="fas fa-plus-circle"></i> Créer un Code
                                </button>
                            </div>

                            <!-- AJOUTEZ ICI LE RESTE DE VOTRE CONTENU GIFTS ORIGINAL -->
                        </div>
                    </main>
                </div>
            `;
            updateUserSection();
            loadMyCodes();
        }

        function claimDirectGift(code) {
            redeemGiftCode(code);
        }

        // 3. Votre fonction redeemGiftCode corrigée
        async function redeemGiftCode(directCode = null) {
            console.log('redeemGiftCode appelée avec:', directCode);
    
            let code;
    
            if (directCode) {
                code = directCode;
            } else {
                const inputElement = document.getElementById('redeem-code-input');
                if (inputElement) {
                    code = inputElement.value.trim();
                } else {
                    code = '';
                }
            }
    
            console.log('Code final:', code);
            if (!code) {
                showToast("Veuillez entrer un code.", "error");
                return;
            }

            const button = event?.target;
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Réclamation...';
            }

            try {
                const result = await apiFetch('/api/gifts/redeem', { 
                    method: 'POST', 
                    body: JSON.stringify({ code }) 
                });

                if (result && result.success) {
                    showToast(result.message, 'success');

                    if (result && result.success) {
                        showToast(result.message, 'success');
    
                        // Si on est sur une page de redeem directe, rafraîchir ET rediriger
                        if (window.location.pathname.startsWith('/redeem/')) {
                            setTimeout(() => {
                                navigate('/');
                                location.reload(); // AJOUTEZ CETTE LIGNE
                            }, 2000);
                        } else {
                            const inputElement = document.getElementById('redeem-code-input');
                            if (inputElement) {
                                inputElement.value = '';
                            }
                        }
    
                        await updateUserSection();
                    }

                    if (window.location.pathname.startsWith('/redeem/')) {
                        setTimeout(() => navigate('/'), 2000);
                    } else {
                        const inputElement = document.getElementById('redeem-code-input');
                        if (inputElement) {
                            inputElement.value = '';
                        }
                    }

                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", "error");
            } finally {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-gift"></i> Réclamer mon cadeau';
                }
            }
        }

        async function renderHistoryPage() {
            document.title = 'StrexBot - Historique';
            const container = document.getElementById('app-container');
            
            // Affiche une structure de base pendant le chargement
            container.innerHTML = `
                <div class="container">
                    <nav>
                        <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;"><img src="/S.png" alt="Logo" class="nav-logo"> StrexBot</div>
                        <div id="user-section"></div>
                    </nav>
                    <main>
                        <div class="account-main">
                            <h1><i class="fas fa-history"></i> Mon Historique</h1>
                            <div class="transactions-list" id="transactions-list">
                                <p>Chargement de l'historique...</p>
                            </div>
                        </div>
                    </main>
                </div>`;
            updateUserSection();
        
            // Récupère et affiche les transactions
            try {
                const transactions = await apiFetch('/api/user/transactions');
                const listContainer = document.getElementById('transactions-list');
        
                if (transactions && transactions.length > 0) {
                    listContainer.innerHTML = transactions.map(t => {
                        const date = new Date(t.timestamp);
                        const amountClass = t.amount >= 0 ? 'positive' : 'negative';
                        const sign = t.amount >= 0 ? '+' : '';
        
                        return `
                        <div class="transaction-item">
                            <div class="transaction-details">
                                <span class="transaction-reason">${t.reason}</span>
                                <span class="transaction-timestamp">${date.toLocaleString()}</span>
                            </div>
                            <span class="transaction-amount ${amountClass}">${sign}${t.amount}</span>
                        </div>`;
                    }).join('');
                } else {
                    listContainer.innerHTML = '<p>Aucune transaction récente.</p>';
                }
            } catch (error) {
                document.getElementById('transactions-list').innerHTML = '<p>Erreur lors du chargement de l\'historique.</p>';
            }
        }

        async function renderDailyPage() {
            document.title = 'StrexBot - Récompense Quotidienne';
            const container = document.getElementById('app-container');
             if (!localStorage.getItem('jwt_token')) {
                container.innerHTML = `<div class="error-page"><h1>Veuillez vous connecter</h1><p>Vous devez être connecté pour accéder à cette page.</p><a href="/" onclick="event.preventDefault(); navigate('/')">Retour à l'accueil</a></div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="container">
                    <nav>
                        <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                            <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                        </div>
                        <div id="user-section"></div>
                    </nav>
                    <main class="daily-main">
                        <div class="daily-hero">
                            <h1><img src="/Coin.png" class="daily-title-coin"> Récompense Quotidienne</h1>
                            <p>Revenez chaque jour pour réclamer une pièce gratuite et augmenter votre solde !</p>
                        </div>
                        <div id="daily-card-container">
                             <div class="daily-card"><p>Chargement...</p></div>
                        </div>
                    </main>
                </div>
            `;
            updateUserSection();
            loadDailyStatus();
        }
        
        async function renderAccountPage() {
            document.title = 'StrexBot - Mon Compte';
            const container = document.getElementById('app-container');
            container.innerHTML = `
                 <div class="container">
                     <nav>
                        <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;"><img src="/S.png" alt="Logo" class="nav-logo"> StrexBot</div>
                        <div id="user-section"></div>
                    </nav>
                    <main>
                        <div class="error-page" style="margin-top: 20px;">
                             <h1><i class="fas fa-user-circle"></i> Mon Compte</h1>
                             <p>Cette page est en cours de construction. Revenez bientôt !</p>
                        </div>
                    </main>
                </div>`;
            updateUserSection();
        }
        
        async function renderAdminPage() {
            document.title = 'StrexBot - Administration';
            const container = document.getElementById('app-container');
            try {
                const userData = await apiFetch('/api/user_data');
                if (!userData || !userData.is_admin) throw new Error('Non admin');
        
                container.innerHTML = `
                    <div class="admin-layout">
                        <aside class="admin-sidebar">
                            <div class="admin-sidebar-header" ...>StrexBot Admin</div>
        
                            <nav class="admin-nav">
                                <a href="#" class="admin-nav-link active" data-page="users"><i class="fas fa-users"></i> <span>Utilisateurs</span></a>
                                <a href="#" class="admin-nav-link" data-page="offer"><i class="fas fa-gift"></i> <span>Offre</span></a>
                                <a href="#" class="admin-nav-link" data-page="ads"><i class="fas fa-video"></i> <span>Publicités</span></a>
                                <a href="#" class="admin-nav-link" data-page="maintenance"><i class="fas fa-tools"></i> <span>Maintenance</span></a>
                            </nav>
                            <a href="/" ... class="admin-back-home">Acceuil</a>
                        </aside>
                        <main id="admin-main-content" class="admin-main"></main>
                    </div>
                `;
                loadAdminPage('users'); // On charge la page 'users' par défaut
                setupAdminNav();
            } catch (e) {
                // ...
            }
        }
        
        function loadAdminPage(page) {
            const contentArea = document.getElementById('admin-main-content');
            if (!contentArea) return;
             if (page === 'users') {
                 contentArea.innerHTML = `<h2>Gestion des Utilisateurs</h2><input type="text" id="user-search-input" class="admin-input" placeholder="Rechercher par ID ou pseudo..."><div id="user-search-results" class="search-results-container"></div>`;
                 document.getElementById('user-search-input').addEventListener('input', handleUserSearch);
             } else if (page === 'maintenance') {
                contentArea.innerHTML = `<h2>Mode Maintenance</h2>
                    <div class="maintenance-card">
                        <div class="maintenance-toggle">
                            <h3>Activer la maintenance</h3>
                            <p>Lorsque la maintenance est activée, seuls les administrateurs peuvent se connecter au site.</p>
                            <label class="switch"><input type="checkbox" id="maintenance-checkbox"><span class="slider"></span></label>
                        </div>
                        <button id="save-maintenance-btn" class="admin-btn"><i class="fas fa-save"></i> Enregistrer</button>
                    </div>`;
                loadMaintenanceStatus();
             } else if (page === 'offer') {
                contentArea.innerHTML = `
                    <h2>Lancer une Offre Globale</h2>
                    <div class="account-card">
                        <p>Créez une offre que les membres pourrons réclamer sur la page d'accueil.</p>
                        <div id="create-offer-form">
                            <label for="offer-amount">Montant en pièces :</label>
                            <input type="number" id="offer-amount" class="admin-input" min="0.01" placeholder="Ex: 100">
                            
                            <label for="offer-message">Message de l'offre :</label>
                            <input type="text" id="offer-message" class="admin-input" placeholder="Ex: Soyez rapide !">
                            
                            <button class="btn btn-primary" onclick="createGlobalOffer()">Lancer l'Offre</button>
                        </div>
                    </div>`;
            } else if (page === 'ads') {
                contentArea.innerHTML = `
                    <h2>Gestion des Publicités</h2>
                    <div class="admin-card">
                        <h3>Ajouter une publicité</h3>
                        <form id="ad-upload-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label>Titre de la publicité :</label>
                                <input type="text" id="ad-title" name="title" class="admin-input" placeholder="Ex: Publicité partenaire" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Lien de redirection (optionnel) :</label>
                                <input type="url" id="ad-click-url" name="click_url" class="admin-input" placeholder="https://example.com">
                                <small style="color: var(--text-muted-color);">Si renseigné, l'utilisateur sera redirigé vers ce lien après avoir regardé la publicité</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Fichier vidéo :</label>
                                <div class="file-upload-area" id="file-upload-area">
                                    <input type="file" id="ad-file" name="video_file" accept="video/*" required style="display: none;">
                                    <div class="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Cliquez pour sélectionner une vidéo</p>
                                        <small>MP4, MOV, AVI, MKV, WEBM - Max 100MB</small>
                                    </div>
                                    <div class="upload-progress" style="display: none;">
                                        <div class="progress-bar">
                                            <div class="progress-fill"></div>
                                        </div>
                                        <span class="progress-text">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Récompense (pièces) :</label>
                                <input type="number" id="ad-reward" name="reward_amount" class="admin-input" value="1" min="0.1" step="0.1" required>
                            </div>
                            
                            <button type="submit" class="admin-btn">
                                <i class="fas fa-upload"></i> Uploader la publicité
                            </button>
                        </form>
                    </div>
                    <div id="ads-list"></div>
                `;
                
                setupFileUpload();
                loadAdsList();
             }
        }

        // --- Fonctions de l'Admin Panel ---
        function setupAdminNav() {
            document.querySelectorAll('.admin-nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    document.querySelector('.admin-nav-link.active')?.classList.remove('active');
                    e.currentTarget.classList.add('active');
                    loadAdminPage(e.currentTarget.dataset.page);
                });
            });
        }
        
        async function handleUserSearch(event) {
            const query = event.target.value.trim();
            const resultsContainer = document.getElementById('user-search-results');
            if (query.length < 3) {
                resultsContainer.innerHTML = '';
                return;
            }
            const users = await apiFetch(`/api/admin/search_users?q=${encodeURIComponent(query)}`);
            if (users && Array.isArray(users)) {
                resultsContainer.innerHTML = users.map(user => `
                    <div class="user-card" id="user-card-${user.user_id}">
                        <div class="user-card-info">
                            <img src="${user.avatar_url}" class="user-card-avatar">
                            <div class="user-card-details">
                                <strong>${user.username}</strong>
                                <small>ID: ${user.user_id}</small>
                                <span class="user-card-coins" id="coins-${user.user_id}"><img src="/Coin.png" class="coin-mini"> ${user.coins}</span>
                            </div>
                        </div>
                        <div class="user-card-actions">
                             <input type="number" step="0.01" class="admin-input small-input" id="coins-input-${user.user_id}" placeholder="Montant">
                             <button class="admin-btn action-btn" onclick="updateUser('${user.user_id}', 'set_coins')">Définir</button>
                             <button class="admin-btn add-btn" onclick="updateUser('${user.user_id}', 'add_coins')">+</button>
                             <button class="admin-btn remove-btn" onclick="updateUser('${user.user_id}', 'remove_coins')">-</button>
                             <button class="admin-btn ${user.banned ? 'unban-btn' : 'ban-btn'}" onclick="updateUser('${user.user_id}', '${user.banned ? 'unban' : 'ban'}')">${user.banned ? 'Débannir' : 'Bannir'}</button>
                        </div>
                    </div>
                `).join('');
            } else {
                resultsContainer.innerHTML = '<p>Aucun utilisateur trouvé.</p>';
            }
        }
        
        async function updateUser(userId, action) {
            const input = document.getElementById(`coins-input-${userId}`);
            const value = (action.includes('coins')) ? input.value : null;
            if (action.includes('coins') && (!value || parseFloat(value) < 0)) {
                showToast("Veuillez entrer un montant valide.", "error");
                return;
            }
            const result = await apiFetch(`/api/admin/update_user/${userId}`, {
                method: 'POST',
                body: JSON.stringify({ action, value })
            });
            if (result) {
                showToast("Utilisateur mis à jour !", "success");
                document.getElementById(`coins-${userId}`).innerHTML = `<img src="/Coin.png" class="coin-mini"> ${result.coins}`;
                if (action === 'ban' || action === 'unban') {
                    handleUserSearch({ target: document.getElementById('user-search-input') });
                }
                input.value = '';
            }
        }
        
        async function loadMaintenanceStatus() {
            const checkbox = document.getElementById('maintenance-checkbox');
            const saveBtn = document.getElementById('save-maintenance-btn');
            
            try {
                const data = await apiFetch('/api/admin/maintenance');
                if (data) checkbox.checked = data.maintenance_enabled;
            } catch {}
            
            saveBtn.addEventListener('click', async () => {
                const enabled = checkbox.checked;
                const result = await apiFetch('/api/admin/maintenance', {
                    method: 'POST', 
                    body: JSON.stringify({ enabled })
                });
                if (result) showToast('Statut de maintenance mis à jour !', 'success');
            });
        }
        
        // --- Fonctions des Cadeaux ---
        function setGiftAmount(amount) {
            document.getElementById('gift-amount').value = amount;
        }

        async function createGift() {
            const amountInput = document.getElementById('gift-amount');
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                showToast("Veuillez entrer un montant valide.", "error");
                return;
            }
            
            try {
                const result = await apiFetch('/api/gifts/create', { method: 'POST', body: JSON.stringify({ amount }) });
                if (result && result.success) {
                    showToast('Code cadeau créé avec succès !', 'success');
                    amountInput.value = '';
                    closeModal('create-gift-modal');
                    await showMyCodes();
                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", "error");
            }
        }

        async function loadMyCodes() {
            try {
                const codes = await apiFetch('/api/gifts/my_codes');
                const count = codes.length || 0;
        
                // Mettre à jour le compteur dans la carte "Mes Codes"
                const countBadge = document.getElementById('my-codes-count');
                if (countBadge) {
                    countBadge.innerText = count;
                }
        
                // Mettre à jour le compteur dans le header de la carte "Créer un Cadeau"
                const headerCount = document.getElementById('codes-count-header');
                if (headerCount) {
                    headerCount.innerText = count;
                }
            } catch {
                const countBadge = document.getElementById('my-codes-count');
                if (countBadge) countBadge.innerText = '0';
        
                const headerCount = document.getElementById('codes-count-header');
                if (headerCount) headerCount.innerText = '0';
            }
        }

        async function showMyCodes() {
            const listContainer = document.getElementById('my-codes-list');
            const modal = document.getElementById('my-codes-modal');
            listContainer.innerHTML = '<p>Chargement des codes...</p>';
            openModal('my-codes-modal');

            try {
                const codes = await apiFetch('/api/gifts/my_codes');
                if (codes && Array.isArray(codes) && codes.length > 0) {
                    listContainer.innerHTML = codes.map(code => {
                        const expires = new Date(code.expires_at + 'Z');
                        return `
                        <div class="my-code-item">
                            <div class="my-code-details">
                                <span class="code-text" onclick="copyToClipboard('${code.redeem_link}')" title="Cliquer pour copier le lien">${code.code} <i class="fas fa-copy"></i></span>
                                <span><img src="/Coin.png" class="coin-mini"> ${code.amount}</span>
                                <small>Expire le: ${expires.toLocaleString()}</small>
                            </div>
                            <button class="btn-delete" onclick="deleteGift('${code.code}')"><i class="fas fa-trash"></i></button>
                        </div>`
                    }).join('');
                } else {
                    listContainer.innerHTML = '<p>Vous n\'avez aucun code cadeau actif.</p>';
                }
            } catch {
                listContainer.innerHTML = '<p>Erreur lors du chargement des codes.</p>';
            }
        }
        
        async function redeemGiftCode(directCode = null) {
            let code; // AJOUTEZ CETTE LIGNE
    
            if (directCode) {
                code = directCode;
            } else {
                const inputElement = document.getElementById('redeem-code-input');
                if (inputElement) {
                    code = inputElement.value.trim();
                } else {
                    code = '';
                }
            }
    
            if (!code) {
                showToast("Veuillez entrer un code.", "error");
                return;
            }
    
            try {
                const result = await apiFetch('/api/gifts/redeem', { 
                    method: 'POST', 
                    body: JSON.stringify({ code }) 
                });
        
                if (result && result.success) {
                    showToast(result.message, 'success');
            
                    // REMPLACEZ codeInput.value = ''; PAR :
                    const inputElement = document.getElementById('redeem-code-input');
                    if (inputElement) {
                        inputElement.value = '';
                    }
            
                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", "error");
            }
        }
        
        async function deleteGift(code) {
            if (!confirm("Voulez-vous vraiment supprimer ce code ? Les pièces vous seront remboursées.")) return;
            
            try {
                const result = await apiFetch('/api/gifts/delete', { method: 'POST', body: JSON.stringify({ code }) });
                if (result && result.success) {
                    showToast(result.message, 'success');
                    await showMyCodes();
                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", "error");
            }
        }
        
        // --- Fonctions Daily Reward ---
        async function loadDailyStatus() {
            const container = document.getElementById('daily-card-container');
            try {
                const status = await apiFetch('/api/daily/status');
                if (status.can_claim) {
                    container.innerHTML = `
                    <div class="daily-card">
                        <div class="daily-coin-animation">
                            <div class="coin-glow"></div>
                            <img src="/Coin.png" alt="Pièce" class="daily-coin available">
                        </div>
                        <h2>Votre pièce quotidienne vous attend !</h2>
                        <p>Cliquez sur le bouton ci-dessous pour réclamer votre récompense.</p>
                        <button id="claim-btn" class="btn-claim-daily" onclick="claimDaily()">
                            <i class="fas fa-hand-holding-usd"></i> Réclamer 1 pièce
                        </button>
                    </div>`;
                } else {
                     container.innerHTML = `
                    <div class="daily-card">
                         <div class="daily-coin-animation">
                            <img src="/Coin.png" alt="Pièce" class="daily-coin claimed">
                        </div>
                        <h2>Déjà réclamé !</h2>
                        <p>Vous avez déjà récupéré votre pièce aujourd'hui. Revenez demain !</p>
                        <div id="countdown-timer" class="countdown"></div>
                    </div>`;
                    startCountdown(status.next_claim);
                }
            } catch (error) {
                 container.innerHTML = `<div class="daily-card"><p>Erreur lors du chargement du statut.</p></div>`;
            }
        }

        async function claimDaily() {
            const claimBtn = document.getElementById('claim-btn');
            claimBtn.disabled = true;
            claimBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Réclamation...';

            try {
                const result = await apiFetch('/api/daily/claim', { method: 'POST' });
                if (result && result.success) {
                    showToast(result.message, 'success');
                    await loadDailyStatus();
                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", 'error');
                claimBtn.disabled = false;
                claimBtn.innerHTML = '<i class="fas fa-hand-holding-usd"></i> Réclamer 1 pièce';
            }
        }

        function startCountdown(endDate) {
            const countdownElement = document.getElementById('countdown-timer');
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = new Date(endDate).getTime() - now;
                
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                countdownElement.innerHTML = `Prochaine récompense dans : <strong>${hours}h ${minutes}m ${seconds}s</strong>`;
                
                if (distance < 0) {
                    clearInterval(interval);
                    loadDailyStatus();
                }
            }, 1000);
        }

        // --- Fonctions Utilitaires ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        async function updateUserSection() {
            const userSection = document.getElementById('user-section');
            if (!userSection) return;
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                 const redirectUri = encodeURIComponent(`${API_URL}/callback`);
                 const scope = encodeURIComponent('identify guilds');
                 userSection.innerHTML = `<a href="https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&response_type=code&redirect_uri=${redirectUri}&scope=identify+guilds" class="btn btn-primary"><i class="fab fa-discord"></i> Se connecter</a>`;
                 return;
            }
            try {
                const userData = await apiFetch('/api/user_data');
                if (userData) {
                    const adminShieldHtml = userData.is_admin ? `<a href="/admin" onclick="event.preventDefault(); navigate('/admin')" class="admin-shield" title="Panneau Admin"><i class="fas fa-user-shield"></i></a>` : '';
                    userSection.innerHTML = `
                        <div class="user-profile">
                            ${adminShieldHtml}
                            <div class="user-balance" onclick="navigate('/daily')" title="Récompense quotidienne">
                                <img src="/Coin.png" class="coin-icon"><span>${userData.coins.toLocaleString()}</span>
                            </div>
                            <div class="user-info" onclick="toggleDropdown()">
                                <img src="${userData.avatar_url}" class="user-avatar">
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="dropdown-menu" id="dropdown-menu">
                                <div class="dropdown-header"><img src="${userData.avatar_url}" class="dropdown-avatar"><span>${userData.username}</span></div>
                                <a href="/history" onclick="event.preventDefault(); navigate('/history')"><i class="fas fa-history"></i> Historique</a>
                                <a href="/earn" onclick="event.preventDefault(); navigate('/earn')"><i class="fas fa-video"></i> Gagner</a>
                                <a href="/buy" onclick="event.preventDefault(); navigate('/buy')"><i class="fas fa-shopping-cart"></i> Acheter</a>
                                <a href="/gifts" onclick="event.preventDefault(); navigate('/gifts')"><i class="fas fa-gift"></i> Cadeaux</a>
                                <a href="/daily" onclick="event.preventDefault(); navigate('/daily')"><i class="fas fa-calendar-check"></i> Quotidien</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Se déconnecter</a>
                            </div>
                        </div>`;
                    
                    const balanceElement = document.getElementById('user-balance');
                    if (balanceElement) balanceElement.innerText = userData.coins.toLocaleString();
                } else {
                    logout();
                }
            } catch { logout(); }
        }

        // Remplacez votre renderBuyPage() par cette version qui gère la reconnexion :

        async function renderBuyPage() {
            document.title = 'StrexBot - Boutique';
            const container = document.getElementById('app-container');
        
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                container.innerHTML = `<div class="error-page">
                    <h1>Veuillez vous connecter</h1>
                    <p>Vous devez être connecté pour accéder à la boutique.</p>
                    <a href="/" onclick="event.preventDefault(); navigate('/')">Retour à l'accueil</a>
                </div>`;
                return;
            }
        
            try {
                const servers = await apiFetch('/api/user/guilds');
                
                container.innerHTML = `
                    <div class="container">
                        <nav>
                            <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                                <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                            </div>
                            <div id="user-section"></div>
                        </nav>
                        <main class="buy-main">
                            <div class="buy-hero">
                                <h1><i class="fas fa-shopping-cart gradient-icon"></i> Boutique</h1>
                                <p>Achetez des crédits pour vos serveurs avec vos pièces.</p>
                            </div>
                            
                            <div class="servers-list">
                                ${Array.isArray(servers) && servers.length > 0 ? servers.map(s => `
                                    <div class="server-card">
                                        <div class="server-header">
                                            ${s.icon ? 
                                                `<img src="${s.icon}" class="server-icon" alt="${s.name}">` : 
                                                '<div class="server-icon-placeholder"><i class="fas fa-server"></i></div>'
                                            }
                                            <div class="server-info">
                                                <h3>${s.name}</h3>
                                                <p>Crédits actuels: <strong>${s.current_credits || 0}</strong></p>
                                            </div>
                                        </div>
                                        
                                        ${!s.bot_present ? `
                                            <div class="bot-not-present">
                                                <p><i class="fas fa-exclamation-triangle"></i> Le bot n'est pas présent</p>
                                                <button class="btn-invite-bot" onclick="inviteBotToServer()">Inviter le bot</button>
                                            </div>
                                        ` : `
                                            <div class="credits-purchase">
                                                <input type="text" class="credits-input" value="Montant" readonly>
                                                <div class="credits-actions">
                                                    <button class="btn-buy-credits" onclick="buyCredits('${s.id}', '${s.name}')">
                                                        <i class="fas fa-shopping-cart"></i> Acheter 10 crédits (1 pièce)
                                                    </button>
                                                    ${s.current_credits > 0 ? `
                                                        <button class="btn-refund-credits" onclick="refundCredits('${s.id}', '${s.name}')">
                                                            <i class="fas fa-undo"></i> Rembourser
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `}
                                        <div id="buy-result-${s.id}"></div>
                                    </div>
                                `).join('') : `
                                    <div class="error-page">
                                        <h2>Aucun serveur trouvé</h2>
                                        <p>Vous devez avoir la permission "Gérer le serveur".</p>
                                    </div>
                                `}
                            </div>
                        </main>
                    </div>
                `;
                updateUserSection();
            } catch (error) {
                console.error("Erreur boutique:", error);
                
                // Vérifier si c'est un problème de token Discord expiré
                if (error.error && (error.error === "discord_token_expired" || error.error === "no_discord_token")) {
                    const redirectUri = encodeURIComponent(`${API_URL}/callback`);
                    const scope = encodeURIComponent('identify guilds');
                    
                    container.innerHTML = `
                        <div class="container">
                            <nav>
                                <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                                    <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                                </div>
                                <div id="user-section"></div>
                            </nav>
                            <main class="error-page" style="margin-top: 50px;">
                                <h1><i class="fas fa-exclamation-triangle"></i> Reconnexion nécessaire</h1>
                                <p>Votre session Discord a expiré. Vous devez vous reconnecter pour accéder à vos serveurs.</p>
                                <a href="https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}" class="btn btn-primary">
                                    <i class="fab fa-discord"></i> Se reconnecter avec Discord
                                </a>
                            </main>
                        </div>
                    `;
                    updateUserSection();
                } else {
                    container.innerHTML = `
                        <div class="error-page">
                            <h1>Erreur</h1>
                            <p>Impossible de charger la boutique.</p>
                            <p><strong>Détails:</strong> ${error.error || error.message || 'Erreur inconnue'}</p>
                        </div>`;
                }
            }
        }

        // Ajoutez ces fonctions dans votre index (4).html :

        function updateCost(serverId) {
            const select = document.getElementById(`credits-${serverId}`);
            const costSpan = document.getElementById(`cost-${serverId}`);
            const credits = parseInt(select.value);
            const cost = credits / 10; // 10 crédits = 1 pièce
            costSpan.textContent = cost;
        }
        
        async function buyCredits(serverId, serverName) {
            const select = document.getElementById(`credits-${serverId}`);
            const credits = parseInt(select.value);
            const cost = credits / 10;
            
            if (!confirm(`Acheter ${credits} crédits pour "${serverName}" pour ${cost} pièce(s) ?`)) {
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Achat...';
            
            try {
                const result = await apiFetch('/api/buy_server_credits', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        guild_id: serverId, 
                        credits: credits
                    })
                });
                
                const resultBox = document.getElementById(`buy-result-${serverId}`);
                if (result.success) {
                    resultBox.innerHTML = `<p style="color: var(--success-color); margin-top: 10px;">✅ ${result.message}</p>`;
                    await updateUserSection();
                    // Recharger la page pour mettre à jour les crédits
                    setTimeout(() => renderBuyPage(), 1000);
                } else {
                    resultBox.innerHTML = `<p style="color: var(--error-color); margin-top: 10px;">❌ ${result.error}</p>`;
                }
            } catch (error) {
                document.getElementById(`buy-result-${serverId}`).innerHTML =
                    `<p style="color: var(--error-color); margin-top: 10px;">❌ ${error.error || "Erreur lors de l'achat."}</p>`;
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-shopping-cart"></i> Acheter';
            }
        }

        async function refundCredits(serverId, serverName) {
            if (!confirm(`Rembourser tous les crédits de "${serverName}" ?`)) return;
            
            try {
                const result = await apiFetch('/api/refund_credits', {
                    method: 'POST',
                    body: JSON.stringify({ guild_id: serverId })
                });
                
                if (result.success) {
                    showToast(result.message, 'success');
                    await updateUserSection();
                    setTimeout(() => renderBuyPage(), 1000);
                }
            } catch (error) {
                showToast(error.error || "Erreur lors du remboursement", "error");
            }
        }
        
        async function inviteBotToServer() {
            try {
                const response = await apiFetch('/api/bot_invite_link');
                window.open(response.invite_url, '_blank');
                showToast("Invitez le bot puis rechargez cette page", "success");
            } catch (error) {
                showToast("Erreur lors de la récupération du lien", "error");
            }
        }
        
        async function loadUserServers() {
            const container = document.getElementById('servers-list');
            
            try {
                const servers = await apiFetch('/api/user/guilds');
                
                if (servers && servers.length > 0) {
                    container.innerHTML = `
                        <div class="servers-grid">
                            ${servers.map(server => `
                                <div class="server-card">
                                    <div class="server-header">
                                        ${server.icon ? 
                                            `<img src="${server.icon}" class="server-icon">` : 
                                            '<div class="server-icon-placeholder"><i class="fas fa-server"></i></div>'
                                        }
                                        <div class="server-info">
                                            <h3>${server.name}</h3>
                                            <p>Crédits actuels: <strong>${server.current_credits}</strong></p>
                                        </div>
                                    </div>
                                    
                                    ${!server.bot_present ? `
                                        <div class="bot-not-present">
                                            <p><i class="fas fa-exclamation-triangle"></i> Le bot n'est pas présent sur ce serveur</p>
                                            <button class="btn-invite-bot" onclick="inviteBotToServer()">
                                                <i class="fas fa-plus"></i> Inviter le bot
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="credits-purchase">
                                            <div class="credits-selector">
                                                <label>Nombre de crédits à acheter :</label>
                                                <select id="credits-${server.id}" onchange="updateCost('${server.id}')">
                                                    <option value="10">10 crédits (1 pièce)</option>
                                                    <option value="50">50 crédits (5 pièces)</option>
                                                    <option value="100">100 crédits (10 pièces)</option>
                                                    <option value="500">500 crédits (50 pièces)</option>
                                                </select>
                                            </div>
                                            <div class="cost-display">
                                                Coût: <span id="cost-${server.id}">1</span> pièce(s)
                                            </div>
                                            <button class="btn-buy-credits" onclick="buyCredits('${server.id}', '${server.name}')">
                                                <i class="fas fa-shopping-cart"></i> Acheter
                                            </button>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="no-servers">
                            <i class="fas fa-server" style="font-size: 3em; margin-bottom: 20px; color: var(--text-muted-color);"></i>
                            <h3>Aucun serveur trouvé</h3>
                            <p>Vous devez avoir la permission "Gérer le serveur" pour acheter des crédits.</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="error-page"><h3>Erreur lors du chargement des serveurs</h3></div>`;
            }
        }
        
        function updateCost(serverId) {
            const select = document.getElementById(`credits-${serverId}`);
            const costSpan = document.getElementById(`cost-${serverId}`);
            const credits = parseInt(select.value);
            const cost = credits / 10;
            costSpan.textContent = cost;
        }
        
        // Remplacez la fonction buyCredits dans index (4).html :

        async function buyCredits(serverId, serverName) {
            const select = document.getElementById(`commands-${serverId}`);
            const credits = parseInt(select.value);
            const cost = credits / 10; // 10 crédits = 1 pièce
            
            if (!confirm(`Acheter ${credits} crédits pour "${serverName}" pour ${cost} pièce(s) ?`)) {
                return;
            }
            
            try {
                const result = await apiFetch('/api/buy_server_credits', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        guild_id: serverId, 
                        credits: credits  // Utiliser "credits" au lieu de "commands_count"
                    })
                });
                
                const resultBox = document.getElementById(`buy-result-${serverId}`);
                if (result.success) {
                    resultBox.innerHTML = `<p class="success">✅ ${result.message}</p>`;
                    await updateUserSection();
                    await loadUserServers(); // Recharger pour mettre à jour les crédits affichés
                } else {
                    resultBox.innerHTML = `<p class="error">❌ ${result.error}</p>`;
                }
            } catch (error) {
                document.getElementById(`buy-result-${serverId}`).innerHTML =
                    `<p class="error">❌ ${error.error || "Erreur lors de l'achat."}</p>`;
            }
        }
        
        async function inviteBotToServer() {
            try {
                const response = await apiFetch('/api/bot_invite_link');
                window.open(response.invite_url, '_blank');
                showToast("Invitez le bot puis rechargez cette page", "success");
            } catch (error) {
                showToast("Erreur lors de la récupération du lien", "error");
            }
        }
    

        async function createGlobalOffer() {
            const amount = parseInt(document.getElementById('offer-amount').value);
            const message = document.getElementById('offer-message').value;
        
            if (!amount || amount <= 0 || !message) {
                showToast("Veuillez remplir tous les champs.", "error");
                return;
            }
            
            try {
                const result = await apiFetch('/api/admin/create_offer', {
                    method: 'POST',
                    body: JSON.stringify({ amount, message })
                });
                if (result.success) {
                    showToast(result.message, "success");
                    document.getElementById('offer-amount').value = '';
                    document.getElementById('offer-message').value = '';
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", "error");
            }
        }

        // Colle ce code dans la balise <script> de ton index.html
        // Dans votre index (10).html, remplacez ces fonctions :

        async function loadGlobalOffer() {
            const container = document.getElementById('global-offer-container');
            if (!container) return;
        
            try {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    container.innerHTML = '';
                    return;
                }
        
                const offer = await apiFetch('/api/global_offer/status');
                
                if (offer && offer.active === true) {
                    if (offer.already_claimed) {
                        container.innerHTML = `
                            <div class="global-offer-box" style="opacity: 0.6;">
                                <div class="offer-icon">✅</div>
                                <div class="offer-details">
                                    <p class="offer-message">Offre déjà réclamée</p>
                                    <p class="offer-amount">Vous avez déjà reçu ${offer.amount} pièces !</p>
                                </div>
                            </div>`;
                    } else {
                        container.innerHTML = `
                            <div class="global-offer-box">
                                <div class="offer-icon">🎁</div>
                                <div class="offer-details">
                                    <p class="offer-message">${offer.message}</p>
                                    <p class="offer-amount">${offer.amount} pièces à gagner !</p>
                                </div>
                                <button class="btn-claim-offer" onclick="claimGlobalOffer()">Réclamer !</button>
                            </div>`;
                    }
                } else {
                    container.innerHTML = '';
                }
            } catch (error) {
                console.error("Erreur lors du chargement de l'offre globale:", error);
                container.innerHTML = '';
            }
        }
        
        async function claimGlobalOffer() {
            const btn = event.target;
            const offerBox = btn.closest('.global-offer-box');
        
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
            try {
                const result = await apiFetch('/api/global_offer/claim', { method: 'POST' });
                if (result.success) {
                    showToast(result.message, "success");
            
                    offerBox.style.transition = 'all 0.5s ease-out';
                    offerBox.style.transform = 'translateY(-20px)';
                    offerBox.style.opacity = '0';
            
                    setTimeout(() => {
                        document.getElementById('global-offer-container').innerHTML = '';
                    }, 500);
            
                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", "error");
                offerBox.style.transition = 'all 0.5s ease-out';
                offerBox.style.transform = 'translateY(-20px)';
                offerBox.style.opacity = '0';
                
                setTimeout(() => {
                    document.getElementById('global-offer-container').innerHTML = '';
                }, 500);
            }
        }
        
        async function renderEarnPage() {
            document.title = "StrexBot - Gagner des pièces";
            const container = document.getElementById("app-container");
            
            container.innerHTML = `
                <div class="container">
                    <nav>
                        <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                            <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                        </div>
                        <div id="user-section"></div>
                    </nav>
                    <main class="earn-main">
                        <div class="earn-hero">
                            <h1><i class="fas fa-video gradient-icon"></i> Gagner avec les pubs</h1>
                            <p>Regardez des publicités et gagnez des pièces !</p>
                        </div>
                        <div id="earn-container">
                            <div class="earn-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Chargement...</p>
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            updateUserSection();
            loadEarnStatus();
        }
        
        async function loadEarnStatus() {
            const container = document.getElementById('earn-container');
            
            try {
                const status = await apiFetch('/api/earn/status');
                
                if (status.can_watch) {
                    container.innerHTML = `
                        <div class="earn-card">
                            <div class="earn-info">
                                <i class="fas fa-play-circle earn-icon"></i>
                                <h3>Publicité disponible</h3>
                                <p>Regardez une courte publicité et gagnez des pièces !</p>
                                <div class="reward-display">
                                    <img src="/Coin.png" class="coin-icon">
                                    <span class="reward-amount">+${status.next_reward || 1}</span>
                                </div>
                            </div>
                            <button class="btn-watch-ad" onclick="startWatchingAd()">
                                <i class="fas fa-play"></i> Regarder une publicité
                            </button>
                        </div>
                    `;
                } else {
                    const secondsRemaining = Math.max(0, Math.floor(status.seconds_remaining || 0));
                    const minutes = Math.floor(secondsRemaining / 60);
                    const seconds = secondsRemaining % 60;
                    
                    container.innerHTML = `
                        <div class="earn-card cooldown">
                            <div class="earn-info">
                                <i class="fas fa-clock earn-icon"></i>
                                <h3>Cooldown actif</h3>
                                <p>Vous devez attendre avant de regarder une autre publicité.</p>
                                <div class="cooldown-display">
                                    <span id="cooldown-timer">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                                </div>
                            </div>
                            <button class="btn-watch-ad" disabled>
                                <i class="fas fa-clock"></i> Veuillez attendre
                            </button>
                        </div>
                    `;
                    
                    if (secondsRemaining > 0) {
                        startCooldownTimer(secondsRemaining);
                    }
                }
            } catch (error) {
                console.error("Erreur lors du chargement:", error);
                container.innerHTML = `
                    <div class="earn-card">
                        <div class="earn-info">
                            <i class="fas fa-exclamation-triangle earn-icon" style="color: var(--error-color);"></i>
                            <h3>Erreur</h3>
                            <p>Impossible de charger les publicités pour le moment.</p>
                        </div>
                        <button class="btn-watch-ad" onclick="loadEarnStatus()">
                            <i class="fas fa-redo"></i> Réessayer
                        </button>
                    </div>
                `;
            }
        }
        
        function startCooldownTimer(remainingSeconds) {
            const timer = document.getElementById('cooldown-timer');
            if (!timer) return;
            
            const interval = setInterval(() => {
                remainingSeconds--;
                
                if (remainingSeconds <= 0) {
                    clearInterval(interval);
                    loadEarnStatus(); // Recharger automatiquement
                    return;
                }
                
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        async function startWatchingAd() {
            const container = document.getElementById('earn-container');
            container.innerHTML = `
                <div class="earn-card">
                    <div class="earn-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Chargement de la publicité...</p>
                    </div>
                </div>
            `;
            
            try {
                const result = await apiFetch('/api/earn/get_ad');
                if (result.success) {
                    showAdPlayer(result.ad);
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="earn-card">
                        <div class="earn-info">
                            <i class="fas fa-exclamation-triangle earn-icon" style="color: var(--error-color);"></i>
                            <h3>Erreur</h3>
                            <p>${error.error || "Erreur lors du chargement"}</p>
                        </div>
                        <button class="btn-watch-ad" onclick="loadEarnStatus()">
                            <i class="fas fa-redo"></i> Réessayer
                        </button>
                    </div>
                `;
            }
        }
        
        function showAdPlayer(ad) {
            const container = document.getElementById('earn-container');
            
            container.innerHTML = `
                <div class="ad-player-container">
                    <div class="ad-player-header">
                        <h3>Publicité : ${ad.title || 'Publicité'}</h3>
                        <button class="ad-close-btn" id="ad-close-btn" disabled title="Regardez jusqu'à la fin">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="video-wrapper">
                        <video id="ad-video" controls preload="metadata" style="width: 100%; border-radius: 12px;">
                            <source src="${ad.video_url}" type="video/mp4">
                            Votre navigateur ne supporte pas la vidéo.
                        </video>
                    </div>
                    
                    <div class="ad-reward-info">
                        <p>Récompense : <img src="/Coin.png" class="coin-mini"> ${ad.reward_amount}</p>
                    </div>
                </div>
            `;
            
            setupAdPlayer(ad);
        }
        
        function setupAdPlayer(ad) {
            const video = document.getElementById('ad-video');
            const closeBtn = document.getElementById('ad-close-btn');
            let hasFinished = false;
            let isProcessing = false; // Empêche les doubles clics
            
            closeBtn.addEventListener('click', function() {
                if (hasFinished && !isProcessing) {
                    isProcessing = true;
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    claimAdReward(ad._id);
                }
            });
        
            video.addEventListener('ended', () => {
                hasFinished = true;
                closeBtn.disabled = false;
                closeBtn.title = "Cliquez pour réclamer votre récompense";
                closeBtn.classList.add('active');
                closeBtn.innerHTML = '<i class="fas fa-check"></i>';
            });
            
            // Empêcher de sauter à la fin
            video.addEventListener('seeked', () => {
                if (video.currentTime > video.duration - 3 && !hasFinished) {
                    video.currentTime = Math.max(0, video.currentTime - 10);
                    showToast("Regardez la vidéo jusqu'à la fin", "warning");
                }
            });
            
            // Désactiver le clic droit
            video.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // Empêcher les contrôles de vitesse
            video.addEventListener('ratechange', () => {
                if (video.playbackRate !== 1) {
                    video.playbackRate = 1;
                    showToast("Vitesse normale requise", "warning");
                }
            });
        }
        
        async function claimAdReward(adId) {
            try {
                const result = await apiFetch('/api/earn/complete_ad', {
                    method: 'POST',
                    body: JSON.stringify({ ad_id: adId })
                });
                
                if (result.success) {
                    showToast(result.message, "success");
                    await updateUserSection();
                    
                    // Afficher le message de succès temporairement
                    const container = document.getElementById('earn-container');
                    container.innerHTML = `
                        <div class="earn-card" style="border-color: var(--success-color); background: rgba(34, 197, 94, 0.1);">
                            <div class="earn-info">
                                <i class="fas fa-check-circle earn-icon" style="color: var(--success-color);"></i>
                                <h3>Récompense réclamée !</h3>
                                <p>Vous avez gagné ${result.reward} pièce(s) !</p>
                                <div class="reward-display" style="background: rgba(34, 197, 94, 0.2);">
                                    <img src="/Coin.png" class="coin-icon">
                                    <span class="reward-amount" style="color: var(--success-color);">+${result.reward}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Recharger automatiquement après 2 secondes
                    setTimeout(() => {
                        loadEarnStatus();
                    }, 2000);
                    
                } else {
                    showToast(result.error || "Erreur lors de la réclamation", "error");
                    loadEarnStatus(); // Recharger en cas d'erreur
                }
            } catch (error) {
                console.error("Erreur lors de la réclamation:", error);
                showToast(error.error || "Erreur lors de la réclamation", "error");
                loadEarnStatus(); // Recharger en cas d'erreur
            }
        }
    
        async function loadRandomAd() {
            const container = document.getElementById('ad-container');
            
            try {
                const result = await apiFetch('/api/earn/get_ad');
                if (result.success) {
                    const ad = result.ad;
                    container.innerHTML = `
                        <div class="ad-player">
                            <div class="ad-header">
                                <h3>${ad.title}</h3>
                                <p>Récompense: <img src="/Coin.png" class="coin-mini"> ${ad.reward_amount}</p>
                            </div>
                            <video id="ad-video" controls preload="metadata" style="width: 100%; max-width: 800px; border-radius: 12px;">
                                <source src="${ad.video_url}" type="video/mp4">
                                Votre navigateur ne supporte pas la vidéo.
                            </video>
                            <div class="ad-controls">
                                <button id="claim-reward-btn" class="btn-claim-reward" disabled>
                                    <i class="fas fa-clock"></i> Regarder jusqu'à la fin
                                </button>
                            </div>
                        </div>
                    `;
                    
                    setupVideoPlayer(ad);
                }
            } catch (error) {
                container.innerHTML = `<div class="error-page"><p>Aucune publicité disponible pour le moment.</p></div>`;
            }
        }
        
        function setupVideoPlayer(ad) {
            const video = document.getElementById('ad-video');
            const claimBtn = document.getElementById('claim-reward-btn');
            let hasWatchedFully = false;
            let hasLeftPage = false;
            
            video.addEventListener('ended', () => {
                hasWatchedFully = true;
                claimBtn.disabled = false;
                claimBtn.innerHTML = '<i class="fas fa-gift"></i> Réclamer la récompense';
                claimBtn.onclick = () => claimAdReward(ad._id);
            });
            
            // Détecter si l'utilisateur quitte la page
            window.addEventListener('beforeunload', () => {
                hasLeftPage = true;
            });
            
            // Empêcher la triche (saut à la fin)
            video.addEventListener('seeked', () => {
                if (video.currentTime > video.duration - 5 && !hasWatchedFully) {
                    video.currentTime = Math.max(0, video.currentTime - 10);
                }
            });
        }

        async function claimGlobalOffer() {
            const btn = event.target;
            const offerBox = btn.closest('.global-offer-box');
    
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const result = await apiFetch('/api/offer/claim', { method: 'POST' });
                if (result.success) {
                    showToast(result.message, "success");
            
                    // Animation de descente
                    offerBox.style.transition = 'all 0.5s ease-out';
                    offerBox.style.transform = 'translateY(-20px)';
                    offerBox.style.opacity = '0';
            
                    setTimeout(() => {
                        document.getElementById('global-offer-container').innerHTML = '';
                    }, 500);
            
                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Une erreur est survenue.", "error");
        
                // Animation de sortie en cas d'erreur aussi
                offerBox.style.transition = 'all 0.5s ease-out';
                offerBox.style.transform = 'translateY(-20px)';
                offerBox.style.opacity = '0';
        
                setTimeout(() => {
                    document.getElementById('global-offer-container').innerHTML = '';
                }, 500);
            }
        }

        async function renderInvitePage(inviterId) {
            document.title = 'StrexBot - Invitation';
            const container = document.getElementById('app-container');
            const token = localStorage.getItem('jwt_token');
    
            if (!token) {
                const redirectUri = encodeURIComponent(`${API_URL}/callback`);
                container.innerHTML = `
                    <div class="container">
                        <div class="invite-card">
                            <h1>🎁 Invitation StrexBot</h1>
                            <p>Connectez-vous et vous gagnerez 1 pièce!</p>
                            <a href="https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&response_type=code&redirect_uri=${redirectUri}&scope=identify guilds.members.read" class="btn btn-primary">Se connecter avec Discord</a>
                        </div>
                    </div>`;
                return;
            }
    
            try {
                const result = await apiFetch(`/api/invite/${inviterId}`);
                if (result.status === 'already_registered') {
                    container.innerHTML = `
                        <div class="container">
                            <div class="invite-card">
                                <h1>✅ Vous êtes déjà enregistré!</h1>
                            </div>
                        </div>`;
                } else if (result.status === 'can_claim') {
                    container.innerHTML = `
                        <div class="container">
                            <div class="invite-card">
                                <h1>🎉 Invitation de ${result.inviter_username}</h1>
                                <p>Réclamez votre récompense!</p>
                                <button class="btn btn-primary" onclick="claimInviteReward('${inviterId}')">Réclamer 1 pièce</button>
                            </div>
                        </div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error-page"><h1>Lien d'invitation invalide</h1></div>`;
            }
    
            updateUserSection();
        }

        async function claimInviteReward(inviterId) {
            try {
                const result = await apiFetch('/api/claim_invite', {
                    method: 'POST',
                    body: JSON.stringify({ inviter_id: inviterId })
                });
        
                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => navigate('/'), 2000);
                    await updateUserSection();
                }
            } catch (error) {
                showToast(error.error || "Erreur", "error");
            }
        }

        // Dans le fichier index (4).html, remplacez dans renderBuyPage() :

        async function renderBuyPage() {
            document.title = 'StrexBot - Boutique';
            const container = document.getElementById('app-container');
        
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                container.innerHTML = `<div class="error-page">
                    <h1>Veuillez vous connecter</h1>
                    <p>Vous devez être connecté pour accéder à la boutique.</p>
                    <a href="/" onclick="event.preventDefault(); navigate('/')">Retour à l'accueil</a>
                </div>`;
                return;
            }
        
            try {
                // CHANGEZ CETTE LIGNE :
                const servers = await apiFetch('/api/user/guilds');
        
                container.innerHTML = `
                    <div class="container">
                        <nav>
                            <div class="nav-brand" onclick="navigate('/')" style="cursor: pointer;">
                                <img src="/S.png" alt="Logo" class="nav-logo"> StrexBot
                            </div>
                            <div id="user-section"></div>
                        </nav>
                        <main class="gifts-main">
                            <div class="gifts-hero">
                                <h1><i class="fas fa-shopping-cart gradient-icon"></i> Boutique</h1>
                                <p>Achetez des crédits pour vos serveurs avec vos pièces.</p>
                            </div>
        
                            <div class="gifts-content">
                                ${servers.length > 0 ? servers.map(s => `
                                    <div class="gift-card">
                                        <div class="card-header">
                                            <i class="fas fa-server"></i>
                                            <h3>${s.name}</h3>
                                        </div>
                                        <p>Achetez des commandes supplémentaires pour ce serveur.</p>
                                        <div class="balance-display">
                                            <span>Crédits actuels: <strong>${s.current_credits || 0}</strong></span>
                                        </div>
                                        ${!s.bot_present ? `
                                            <div class="bot-not-present">
                                                <p><i class="fas fa-exclamation-triangle"></i> Le bot n'est pas présent sur ce serveur</p>
                                                <button class="btn-invite-bot" onclick="inviteBotToServer()">
                                                    <i class="fas fa-plus"></i> Inviter le bot
                                                </button>
                                            </div>
                                        ` : `
                                            <div class="balance-display">
                                                <img src="/Coin.png" class="balance-coin">
                                                <input type="number" id="commands-${s.id}" min="1" value="10" style="width:80px; text-align:center;">
                                                <span>crédits</span>
                                            </div>
                                            <button class="btn-gift-action" onclick="buyCredits('${s.id}', '${s.name}')">
                                                <i class="fas fa-coins"></i> Acheter
                                            </button>
                                        `}
                                        <div id="buy-result-${s.id}"></div>
                                    </div>
                                `).join('') : `
                                    <div class="error-page">
                                        <h2>Aucun serveur trouvé</h2>
                                        <p>Vous devez avoir la permission "Gérer le serveur" pour acheter des crédits.</p>
                                    </div>
                                `}
                            </div>
                        </main>
                    </div>
                `;
                updateUserSection();
            } catch (e) {
                console.error("Erreur lors du chargement de la boutique:", e);
                container.innerHTML = `<div class="error-page"><h1>Erreur</h1><p>Impossible de charger la boutique.</p></div>`;
            }
        }

        async function createAd() {
            const title = document.getElementById('ad-title').value;
            const url = document.getElementById('ad-url').value;
            const reward = parseFloat(document.getElementById('ad-reward').value);
            
            if (!title || !url || !reward) {
                showToast("Veuillez remplir tous les champs", "error");
                return;
            }
            
            try {
                const result = await apiFetch('/api/admin/ads', {
                    method: 'POST',
                    body: JSON.stringify({ title, video_url: url, reward_amount: reward })
                });
                
                if (result.success) {
                    showToast("Publicité ajoutée avec succès", "success");
                    document.getElementById('ad-title').value = '';
                    document.getElementById('ad-url').value = '';
                    document.getElementById('ad-reward').value = '1';
                    loadAdsList();
                }
            } catch (error) {
                showToast(error.error || "Erreur", "error");
            }
        }
        
        async function loadAdsList() {
            const container = document.getElementById('ads-list');
            
            try {
                const ads = await apiFetch('/api/admin/ads');
                
                container.innerHTML = `
                    <div class="admin-card">
                        <h3>Publicités existantes (${ads.length})</h3>
                        ${ads.length > 0 ? ads.map(ad => `
                            <div class="ad-item" id="ad-item-${ad._id}">
                                <div class="ad-details">
                                    <div class="ad-title-edit">
                                        <strong class="ad-title-display">${ad.title}</strong>
                                        <input type="text" class="ad-title-input" value="${ad.title}" style="display: none;">
                                    </div>
                                    <div class="ad-reward-edit">
                                        <small class="ad-reward-display">Récompense: ${ad.reward_amount} pièce(s)</small>
                                        <input type="number" class="ad-reward-input" value="${ad.reward_amount}" step="0.1" min="0.1" style="display: none;">
                                    </div>
                                    <a href="${ad.video_url}" target="_blank" class="ad-preview">Voir la vidéo</a>
                                </div>
                                <div class="ad-actions">
                                    <button class="admin-btn edit-btn" onclick="editAd('${ad._id}')">
                                        <i class="fas fa-edit"></i> Modifier
                                    </button>
                                    <button class="admin-btn save-btn" onclick="saveAd('${ad._id}')" style="display: none;">
                                        <i class="fas fa-save"></i> Sauvegarder
                                    </button>
                                    <button class="admin-btn cancel-btn" onclick="cancelEdit('${ad._id}')" style="display: none;">
                                        <i class="fas fa-times"></i> Annuler
                                    </button>
                                    <button class="admin-btn remove-btn" onclick="deleteAd('${ad._id}')">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p>Aucune publicité configurée.</p>'}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<p>Erreur lors du chargement des publicités.</p>';
            }
        }
        
        function editAd(adId) {
            const item = document.getElementById(`ad-item-${adId}`);
            const titleDisplay = item.querySelector('.ad-title-display');
            const titleInput = item.querySelector('.ad-title-input');
            const rewardDisplay = item.querySelector('.ad-reward-display');
            const rewardInput = item.querySelector('.ad-reward-input');
            const editBtn = item.querySelector('.edit-btn');
            const saveBtn = item.querySelector('.save-btn');
            const cancelBtn = item.querySelector('.cancel-btn');
            
            // Afficher les champs d'édition
            titleDisplay.style.display = 'none';
            titleInput.style.display = 'block';
            rewardDisplay.style.display = 'none';
            rewardInput.style.display = 'block';
            
            // Changer les boutons
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            titleInput.focus();
        }
        
        function cancelEdit(adId) {
            const item = document.getElementById(`ad-item-${adId}`);
            const titleDisplay = item.querySelector('.ad-title-display');
            const titleInput = item.querySelector('.ad-title-input');
            const rewardDisplay = item.querySelector('.ad-reward-display');
            const rewardInput = item.querySelector('.ad-reward-input');
            const editBtn = item.querySelector('.edit-btn');
            const saveBtn = item.querySelector('.save-btn');
            const cancelBtn = item.querySelector('.cancel-btn');
            
            // Réinitialiser les valeurs
            titleInput.value = titleDisplay.textContent;
            rewardInput.value = rewardDisplay.textContent.match(/[\d.]+/)[0];
            
            // Afficher les éléments d'affichage
            titleDisplay.style.display = 'block';
            titleInput.style.display = 'none';
            rewardDisplay.style.display = 'block';
            rewardInput.style.display = 'none';
            
            // Changer les boutons
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }
        
        async function saveAd(adId) {
            const item = document.getElementById(`ad-item-${adId}`);
            const titleInput = item.querySelector('.ad-title-input');
            const rewardInput = item.querySelector('.ad-reward-input');
            const saveBtn = item.querySelector('.save-btn');
            
            const title = titleInput.value.trim();
            const reward = parseFloat(rewardInput.value);
            
            if (!title || !reward || reward <= 0) {
                showToast("Veuillez remplir tous les champs correctement", "error");
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const result = await apiFetch(`/api/admin/ads/${adId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ title, reward_amount: reward })
                });
                
                if (result.success) {
                    showToast("Publicité modifiée avec succès", "success");
                    loadAdsList(); // Recharger la liste
                }
            } catch (error) {
                showToast(error.error || "Erreur lors de la modification", "error");
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Sauvegarder';
            }
        }
        
        async function buyCommands(guildId) {
            const commandsCount = parseInt(document.getElementById(`commands-${guildId}`).value);
        
            try {
                const result = await apiFetch('/api/buy_commands', {
                    method: 'POST',
                    body: JSON.stringify({ guild_id: guildId, commands_count: commandsCount })
                });
        
                const resultBox = document.getElementById(`buy-result-${guildId}`);
                if (result.success) {
                    resultBox.innerHTML = `<p class="success">✅ ${result.message} (coût: ${result.cost} pièces)</p>`;
                    await updateUserSection();
                } else {
                    resultBox.innerHTML = `<p class="error">❌ ${result.error}</p>`;
                }
            } catch (error) {
                document.getElementById(`buy-result-${guildId}`).innerHTML =
                    `<p class="error">❌ Erreur lors de l'achat.</p>`;
            }
        }
        async function apiFetch(endpoint, options = {}) {
            const token = localStorage.getItem('jwt_token');
            const defaultOptions = { headers: { 'Content-Type': 'application/json' } };
            if (token) defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            const mergedOptions = { ...defaultOptions, ...options };
            
            const response = await fetch(`${API_URL}${endpoint}`, mergedOptions);
            const responseData = await response.json();
            if (!response.ok) throw responseData;
            return responseData;
        }
        
        function logout() { localStorage.removeItem('jwt_token'); navigate('/'); }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }
        
        function toggleDropdown() { document.getElementById('dropdown-menu')?.classList.toggle('show'); }

        function setupFileUpload() {
            const uploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('ad-file');
            const form = document.getElementById('ad-upload-form');
            
            // Click sur la zone d'upload
            uploadArea.addEventListener('click', () => {
                if (!uploadArea.classList.contains('uploading')) {
                    fileInput.click();
                }
            });
            
            // Drag & Drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect(files[0]);
                }
            });
            
            // Sélection de fichier
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            // Soumission du formulaire
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                uploadAd();
            });
        }
        
        function handleFileSelect(file) {
            const uploadArea = document.getElementById('file-upload-area');
            const placeholder = uploadArea.querySelector('.upload-placeholder');
            
            // Vérifier la taille
            if (file.size > 100 * 1024 * 1024) {
                showToast("Fichier trop volumineux (max 100MB)", "error");
                return;
            }
            
            // Vérifier le format
            const allowedTypes = ['video/mp4', 'video/mov', 'video/avi', 'video/mkv', 'video/webm'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp4|mov|avi|mkv|webm)$/i)) {
                showToast("Format de fichier non supporté", "error");
                return;
            }
            
            // Afficher les infos du fichier
            placeholder.innerHTML = `
                <i class="fas fa-video"></i>
                <p><strong>${file.name}</strong></p>
                <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
            `;
            
            uploadArea.classList.add('file-selected');
        }
        
        async function uploadAd() {
            const form = document.getElementById('ad-upload-form');
            const uploadArea = document.getElementById('file-upload-area');
            const progressDiv = uploadArea.querySelector('.upload-progress');
            const progressBar = progressDiv.querySelector('.progress-fill');
            const progressText = progressDiv.querySelector('.progress-text');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            const formData = new FormData(form);
            
            // Afficher la barre de progression
            uploadArea.classList.add('uploading');
            progressDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                const xhr = new XMLHttpRequest();
                
                // Progress handler
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }
                });
                
                // Completion handler
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        if (result.success) {
                            showToast("Publicité ajoutée avec succès", "success");
                            form.reset();
                            resetUploadArea();
                            loadAdsList();
                        } else {
                            showToast(result.error || "Erreur lors de l'upload", "error");
                        }
                    } else {
                        showToast("Erreur lors de l'upload", "error");
                    }
                    
                    uploadArea.classList.remove('uploading');
                    progressDiv.style.display = 'none';
                    submitBtn.disabled = false;
                });
                
                xhr.addEventListener('error', () => {
                    showToast("Erreur de connexion", "error");
                    uploadArea.classList.remove('uploading');
                    progressDiv.style.display = 'none';
                    submitBtn.disabled = false;
                });
                
                // Envoyer la requête
                const token = localStorage.getItem('jwt_token');
                xhr.open('POST', `${API_URL}/api/admin/ads`);
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);
                
            } catch (error) {
                showToast("Erreur lors de l'upload", "error");
                uploadArea.classList.remove('uploading');
                progressDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }
        
        function resetUploadArea() {
            const uploadArea = document.getElementById('file-upload-area');
            const placeholder = uploadArea.querySelector('.upload-placeholder');
            
            placeholder.innerHTML = `
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Cliquez pour sélectionner une vidéo</p>
                <small>MP4, MOV, AVI, MKV, WEBM - Max 100MB</small>
            `;
            
            uploadArea.classList.remove('file-selected');
        }
        
        function setupScrollAnimations() {
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        if (entry.target.classList.contains('features')) {
                            // Animation séquentielle pour mobile
                            const isMobile = window.innerWidth <= 768;
                            const featureItems = entry.target.querySelectorAll('.feature-item');
                            
                            if (isMobile) {
                                featureItems.forEach((item, index) => {
                                    setTimeout(() => {
                                        item.classList.add('visible');
                                    }, index * 200); // 200ms de délai entre chaque carte
                                });
                            } else {
                                featureItems.forEach(item => {
                                    item.classList.add('visible');
                                });
                            }
                            entry.target.classList.add('visible');
                        } else {
                            entry.target.classList.add('visible');
                        }
                    }
                });
            }, { threshold: 0.1 });
    
            document.querySelectorAll('.fade-in-section').forEach(el => observer.observe(el));
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("Lien de partage copié !", "success");
            }, () => {
                showToast("Erreur de copie", "error");
            });
        }
        
        window.onclick = e => { if (!e.target.closest('.user-profile')) document.querySelector('.dropdown-menu.show')?.classList.remove('show'); };
    </script>
</body>
</html>
